<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شات الذكاء الاصطناعي المتقدم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #10a37f;
            --primary-dark: #0d8c6d;
            --secondary-color: #343541;
            --chat-bg: #444654;
            --user-bg: #343541;
            --text-color: #ececf1;
            --border-color: #565869;
            --sidebar-bg: #202123;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            background-color: var(--secondary-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            z-index: 10;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h2 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header h2 i {
            color: var(--primary-color);
        }

        .new-chat-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            width: 100%;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
        }

        .new-chat-btn:hover {
            background-color: var(--primary-dark);
        }

        .conversations {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .conversation-item {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .conversation-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .conversation-item.active {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .conversation-item i {
            font-size: 14px;
            color: #8e8ea0;
        }

        .conversation-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-info:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
        }

        .user-status {
            font-size: 12px;
            color: #8e8ea0;
        }

        .toggle-sidebar {
            display: none;
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: var(--sidebar-bg);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 20;
            align-items: center;
            justify-content: center;
        }

        /* Main Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--secondary-color);
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: var(--text-color);
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .chat-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message {
            display: flex;
            gap: 20px;
            max-width: 100%;
            padding: 20px 0;
        }

        .message.user {
            background-color: var(--user-bg);
        }

        .message.assistant {
            background-color: var(--chat-bg);
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .user .avatar {
            background-color: #5436da;
        }

        .assistant .avatar {
            background-color: var(--primary-color);
        }

        .message-content {
            flex: 1;
            padding-top: 5px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .message-content p {
            margin-bottom: 10px;
        }

        .message-content code {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message-content ul, .message-content ol {
            padding-right: 20px;
            margin: 10px 0;
        }

        .message-content li {
            margin-bottom: 5px;
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 10px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-color);
            opacity: 0.6;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.6; }
            40% { transform: translateY(-10px); opacity: 1; }
        }

        /* Input Area */
        .input-container {
            padding: 24px;
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            position: relative;
            display: flex;
        }

        .chat-input {
            width: 100%;
            background-color: rgba(64, 65, 79, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 52px 16px 16px;
            color: var(--text-color);
            font-size: 16px;
            resize: none;
            min-height: 56px;
            max-height: 200px;
            line-height: 1.5;
            transition: var(--transition);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: rgba(64, 65, 79, 1);
        }

        .send-btn {
            position: absolute;
            left: 12px;
            bottom: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .send-btn:hover {
            background-color: var(--primary-dark);
        }

        .send-btn:disabled {
            background-color: #6e6e80;
            cursor: not-allowed;
        }

        .input-footer {
            display: flex;
            justify-content: center;
            margin-top: 12px;
            font-size: 12px;
            color: #8e8ea0;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 0 24px;
        }

        .welcome-title {
            font-size: 32px;
            margin-bottom: 16px;
            background: linear-gradient(90deg, var(--primary-color), #5436da);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtitle {
            font-size: 18px;
            color: #8e8ea0;
            margin-bottom: 40px;
            max-width: 600px;
        }

        .capabilities {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 800px;
            margin-bottom: 40px;
        }

        .capability {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            width: 240px;
        }

        .capability i {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 12px;
        }

        .capability h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .capability p {
            font-size: 14px;
            color: #8e8ea0;
        }

        /* API Configuration Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }

        .modal {
            background-color: var(--secondary-color);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 18px;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .close-modal:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            background-color: rgba(64, 65, 79, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                right: 0;
                height: 100%;
                transform: translateX(100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .toggle-sidebar {
                display: flex;
            }
            
            .capabilities {
                flex-direction: column;
                align-items: center;
            }
            
            .capability {
                width: 100%;
                max-width: 300px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-robot"></i> الذكاء الاصطناعي</h2>
                <button class="new-chat-btn" id="newChatBtn">
                    <i class="fas fa-plus"></i> محادثة جديدة
                </button>
            </div>
            
            <div class="conversations" id="conversationsList">
                <!-- Conversations will be dynamically added here -->
            </div>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">م</div>
                    <div class="user-details">
                        <div class="user-name">مستخدم</div>
                        <div class="user-status">متصل</div>
                    </div>
                    <i class="fas fa-cog" id="settingsBtn"></i>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="chat-container">
            <button class="toggle-sidebar" id="toggleSidebar">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="chat-header">
                <div class="chat-title" id="currentChatTitle">شات الذكاء الاصطناعي</div>
                <div class="chat-actions">
                    <button class="chat-action-btn" id="clearChatBtn" title="مسح المحادثة">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button class="chat-action-btn" id="toggleDarkMode" title="تبديل السمة">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <h1 class="welcome-title">شات الذكاء الاصطناعي المتقدم</h1>
                    <p class="welcome-subtitle">اطرح أي سؤال وسأحاول تقديم أفضل إجابة ممكنة. يمكنني المساعدة في البرمجة، الكتابة، التحليل، وغير ذلك.</p>
                    
                    <div class="capabilities">
                        <div class="capability">
                            <i class="fas fa-lightbulb"></i>
                            <h3>أفكار إبداعية</h3>
                            <p>يمكنني مساعدتك في توليد أفكار إبداعية لمشاريعك</p>
                        </div>
                        <div class="capability">
                            <i class="fas fa-code"></i>
                            <h3>كتابة وتصحيح الشيفرات</h3>
                            <p>أساعد في كتابة وتصحيح الشيفرات البرمجية بلغات متعددة</p>
                        </div>
                        <div class="capability">
                            <i class="fas fa-book"></i>
                            <h3>شرح المفاهيم</h3>
                            <p>أشرح المفاهيم المعقدة بطريقة مبسطة وسهلة الفهم</p>
                        </div>
                        <div class="capability">
                            <i class="fas fa-language"></i>
                            <h3>ترجمة وتحليل النصوص</h3>
                            <p>أترجم النصوص بين اللغات وأحلل المحتوى المكتوب</p>
                        </div>
                    </div>
                    
                    <p class="input-footer">ابدأ بالكتابة في المربع أدناه لبدء المحادثة</p>
                </div>
                
                <!-- Messages will be dynamically added here -->
            </div>
            
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="اكتب رسالتك هنا... (اضغط Enter للإرسال، Shift+Enter للسطر الجديد)"
                        rows="1"
                    ></textarea>
                    <button class="send-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="input-footer">
                    <span>شات الذكاء الاصطناعي يمكن أن يخطئ في بعض المعلومات. تأكد من التحقق من المعلومات المهمة.</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- API Configuration Modal -->
    <div class="modal-overlay" id="apiConfigModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3>إعدادات API</h3>
                <button class="close-modal" id="closeModalBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="apiKey">مفتاح API</label>
                    <input 
                        type="password" 
                        id="apiKey" 
                        placeholder="أدخل مفتاح API الخاص بك"
                        value=""
                    >
                </div>
                <div class="form-group">
                    <label for="apiProvider">مزود API</label>
                    <select id="apiProvider">
                        <option value="openai">OpenAI</option>
                        <option value="custom">مخصص (Custom Endpoint)</option>
                    </select>
                </div>
                <div class="form-group" id="customEndpointGroup" style="display: none;">
                    <label for="customEndpoint">رابط API المخصص</label>
                    <input 
                        type="text" 
                        id="customEndpoint" 
                        placeholder="https://api.example.com/v1/chat/completions"
                        value=""
                    >
                </div>
                <div class="form-group">
                    <label for="model">النموذج</label>
                    <select id="model">
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="temperature">درجة الإبداع (Temperature)</label>
                    <input 
                        type="range" 
                        id="temperature" 
                        min="0" 
                        max="1" 
                        step="0.1" 
                        value="0.7"
                    >
                    <span id="temperatureValue">0.7</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelBtn">إلغاء</button>
                <button class="btn btn-primary" id="saveApiBtn">حفظ الإعدادات</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const newChatBtn = document.getElementById('newChatBtn');
        const conversationsList = document.getElementById('conversationsList');
        const messagesContainer = document.getElementById('messagesContainer');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const apiConfigModal = document.getElementById('apiConfigModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveApiBtn = document.getElementById('saveApiBtn');
        const apiProviderSelect = document.getElementById('apiProvider');
        const customEndpointGroup = document.getElementById('customEndpointGroup');
        const temperatureSlider = document.getElementById('temperature');
        const temperatureValue = document.getElementById('temperatureValue');
        const currentChatTitle = document.getElementById('currentChatTitle');

        // State variables
        let conversations = JSON.parse(localStorage.getItem('ai-chat-conversations')) || [];
        let currentConversationId = null;
        let isWaitingForResponse = false;
        let apiSettings = JSON.parse(localStorage.getItem('ai-chat-api-settings')) || {
            apiKey: '',
            apiProvider: 'openai',
            customEndpoint: '',
            model: 'gpt-3.5-turbo',
            temperature: 0.7
        };

        // Initialize the app
        function init() {
            // Load API settings
            loadApiSettings();
            
            // Load conversations
            loadConversations();
            
            // If there are conversations, show the last one
            if (conversations.length > 0) {
                switchToConversation(conversations[conversations.length - 1].id);
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Auto-resize textarea
            setupTextareaAutoResize();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Toggle sidebar on mobile
            toggleSidebarBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });

            // New chat button
            newChatBtn.addEventListener('click', createNewConversation);

            // Send message on button click
            sendBtn.addEventListener('click', sendMessage);

            // Send message on Enter key (without Shift)
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Clear chat button
            clearChatBtn.addEventListener('click', () => {
                if (currentConversationId && confirm('هل أنت متأكد من رغبتك في مسح هذه المحادثة؟')) {
                    clearCurrentConversation();
                }
            });

            // Settings button
            settingsBtn.addEventListener('click', () => {
                apiConfigModal.style.display = 'flex';
            });

            // Close modal buttons
            closeModalBtn.addEventListener('click', () => {
                apiConfigModal.style.display = 'none';
            });

            cancelBtn.addEventListener('click', () => {
                apiConfigModal.style.display = 'none';
            });

            // Save API settings
            saveApiBtn.addEventListener('click', saveApiSettings);

            // API provider change
            apiProviderSelect.addEventListener('change', () => {
                if (apiProviderSelect.value === 'custom') {
                    customEndpointGroup.style.display = 'block';
                } else {
                    customEndpointGroup.style.display = 'none';
                }
            });

            // Temperature slider
            temperatureSlider.addEventListener('input', () => {
                temperatureValue.textContent = temperatureSlider.value;
            });

            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === apiConfigModal) {
                    apiConfigModal.style.display = 'none';
                }
            });
        }

        // Setup textarea auto-resize
        function setupTextareaAutoResize() {
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }

        // Load API settings into the form
        function loadApiSettings() {
            document.getElementById('apiKey').value = apiSettings.apiKey || '';
            document.getElementById('apiProvider').value = apiSettings.apiProvider || 'openai';
            document.getElementById('customEndpoint').value = apiSettings.customEndpoint || '';
            document.getElementById('model').value = apiSettings.model || 'gpt-3.5-turbo';
            document.getElementById('temperature').value = apiSettings.temperature || 0.7;
            document.getElementById('temperatureValue').textContent = apiSettings.temperature || 0.7;
            
            if (apiSettings.apiProvider === 'custom') {
                customEndpointGroup.style.display = 'block';
            }
        }

        // Save API settings
        function saveApiSettings() {
            apiSettings = {
                apiKey: document.getElementById('apiKey').value,
                apiProvider: document.getElementById('apiProvider').value,
                customEndpoint: document.getElementById('customEndpoint').value,
                model: document.getElementById('model').value,
                temperature: parseFloat(document.getElementById('temperature').value)
            };
            
            localStorage.setItem('ai-chat-api-settings', JSON.stringify(apiSettings));
            apiConfigModal.style.display = 'none';
            
            alert('تم حفظ إعدادات API بنجاح');
        }

        // Load conversations to sidebar
        function loadConversations() {
            conversationsList.innerHTML = '';
            
            conversations.forEach(conversation => {
                const conversationElement = document.createElement('div');
                conversationElement.className = `conversation-item ${conversation.id === currentConversationId ? 'active' : ''}`;
                conversationElement.dataset.id = conversation.id;
                
                conversationElement.innerHTML = `
                    <i class="fas fa-message"></i>
                    <div class="conversation-title">${conversation.title}</div>
                `;
                
                conversationElement.addEventListener('click', () => {
                    switchToConversation(conversation.id);
                    // Close sidebar on mobile
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                });
                
                conversationsList.appendChild(conversationElement);
            });
        }

        // Create a new conversation
        function createNewConversation() {
            const newConversation = {
                id: Date.now().toString(),
                title: `محادثة جديدة ${conversations.length + 1}`,
                messages: [],
                createdAt: new Date().toISOString()
            };
            
            conversations.push(newConversation);
            localStorage.setItem('ai-chat-conversations', JSON.stringify(conversations));
            
            loadConversations();
            switchToConversation(newConversation.id);
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
            }
        }

        // Switch to a conversation
        function switchToConversation(conversationId) {
            currentConversationId = conversationId;
            const conversation = conversations.find(c => c.id === conversationId);
            
            if (!conversation) return;
            
            // Update UI
            currentChatTitle.textContent = conversation.title;
            
            // Clear messages container
            messagesContainer.innerHTML = '';
            welcomeScreen.style.display = 'none';
            
            // Add messages
            conversation.messages.forEach(message => {
                addMessageToUI(message.role, message.content, message.id);
            });
            
            // Update active conversation in sidebar
            document.querySelectorAll('.conversation-item').forEach(item => {
                if (item.dataset.id === conversationId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Scroll to bottom
            scrollToBottom();
        }

        // Clear current conversation
        function clearCurrentConversation() {
            const conversationIndex = conversations.findIndex(c => c.id === currentConversationId);
            
            if (conversationIndex !== -1) {
                conversations[conversationIndex].messages = [];
                localStorage.setItem('ai-chat-conversations', JSON.stringify(conversations));
                
                // Reload messages
                switchToConversation(currentConversationId);
            }
        }

        // Send message
        async function sendMessage() {
            const message = chatInput.value.trim();
            
            if (!message || isWaitingForResponse) return;
            
            // Clear input
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            // Add user message to UI
            const userMessageId = Date.now().toString();
            addMessageToUI('user', message, userMessageId);
            
            // Add to conversation
            const conversation = conversations.find(c => c.id === currentConversationId);
            if (conversation) {
                conversation.messages.push({
                    id: userMessageId,
                    role: 'user',
                    content: message
                });
                
                // Update conversation title if it's the first message
                if (conversation.messages.length === 1) {
                    conversation.title = message.substring(0, 30) + (message.length > 30 ? '...' : '');
                    currentChatTitle.textContent = conversation.title;
                    loadConversations();
                }
                
                localStorage.setItem('ai-chat-conversations', JSON.stringify(conversations));
            } else {
                // Create a new conversation if none exists
                createNewConversation();
                await new Promise(resolve => setTimeout(resolve, 100));
                sendMessage();
                return;
            }
            
            // Show typing indicator
            showTypingIndicator();
            
            // Get AI response
            isWaitingForResponse = true;
            sendBtn.disabled = true;
            
            try {
                const aiResponse = await getAIResponse(message, conversation.messages);
                
                // Remove typing indicator
                removeTypingIndicator();
                
                // Add AI response to UI
                const aiMessageId = Date.now().toString() + '-ai';
                addMessageToUI('assistant', aiResponse, aiMessageId);
                
                // Add to conversation
                conversation.messages.push({
                    id: aiMessageId,
                    role: 'assistant',
                    content: aiResponse
                });
                
                localStorage.setItem('ai-chat-conversations', JSON.stringify(conversations));
                
            } catch (error) {
                // Remove typing indicator
                removeTypingIndicator();
                
                // Show error message
                const errorMessageId = Date.now().toString() + '-error';
                addMessageToUI('assistant', `حدث خطأ: ${error.message}.\n\nتأكد من إعدادات API الخاصة بك.`, errorMessageId);
            }
            
            isWaitingForResponse = false;
            sendBtn.disabled = false;
            
            // Scroll to bottom
            scrollToBottom();
        }

        // Get AI response from API
        async function getAIResponse(userMessage, conversationHistory) {
            // Check if API key is set
            if (!apiSettings.apiKey && apiSettings.apiProvider === 'openai') {
                throw new Error('لم يتم تعيين مفتاح API. الرجاء إعداده من خلال إعدادات API.');
            }
            
            // Prepare messages for API
            const messages = conversationHistory
                .slice(-10) // Limit context window
                .map(msg => ({
                    role: msg.role,
                    content: msg.content
                }));
            
            // Prepare request payload
            const payload = {
                model: apiSettings.model,
                messages: messages,
                temperature: apiSettings.temperature,
                max_tokens: 1000
            };
            
            // Determine API endpoint
            let apiUrl = 'https://api.openai.com/v1/chat/completions';
            let apiKey = apiSettings.apiKey;
            
            if (apiSettings.apiProvider === 'custom' && apiSettings.customEndpoint) {
                apiUrl = apiSettings.customEndpoint;
                // For custom endpoints, API key might not be needed or could be handled differently
            }
            
            // Make API request
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    throw new Error('مفتاح API غير صالح. الرجاء التحقق من المفتاح وإعادة المحاولة.');
                } else if (response.status === 429) {
                    throw new Error('تم تجاوز الحد المسموح به للطلبات. الرجاء المحاولة لاحقاً.');
                } else {
                    throw new Error(`خطأ في API: ${response.status}`);
                }
            }
            
            const data = await response.json();
            
            if (data.choices && data.choices.length > 0) {
                return data.choices[0].message.content;
            } else {
                throw new Error('استجابة غير صالحة من API');
            }
        }

        // Add message to UI
        function addMessageToUI(role, content, messageId) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.id = `message-${messageId}`;
            
            const avatar = role === 'user' 
                ? '<i class="fas fa-user"></i>' 
                : '<i class="fas fa-robot"></i>';
            
            // Format content with basic markdown-like styling
            let formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
            
            // Handle code blocks
            formattedContent = formattedContent.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code>${code}</code></pre>`;
            });
            
            messageDiv.innerHTML = `
                <div class="avatar">${avatar}</div>
                <div class="message-content">${formattedContent}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            // Hide welcome screen if visible
            if (welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
            }
        }

        // Show typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typing-indicator';
            
            typingDiv.innerHTML = `
                <div class="avatar"><i class="fas fa-robot"></i></div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            scrollToBottom();
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Scroll to bottom of messages
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
